<!DOCTYPE HTML>
<html>
<head>
  <title>{{ title }}</title>

  <style>
    body, html {
      font-family: arial, sans-serif;
      font-size: 11pt;
    }

    #visualization {
      box-sizing: border-box;
      width: 100%;
      height: 300px;
    }

    .vis-item.green {
      background-color: greenyellow;
      border-color: green;
    }

    .vis-item.orange {
      background-color: gold;
      border-color: orange;
    }

    .vis-item.blue {
      background-color: deepskyblue;
      border-color: blue;
    }

    .vis-item.red {
      background-color: coral;
      border-color: orange;
    }

  </style>

  <!-- note: moment.js must be loaded before vis-timeline-graph2d or the embedded version of moment.js is used -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>

  <script src="https://visjs.github.io/vis-timeline/standalone/umd/vis-timeline-graph2d.min.js"></script>
  <link href="https://visjs.github.io/vis-timeline/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />

  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet" type="text/css" />

</head>
<body>
<p>
   {{ body }}
</p>
<p>
<div>
<span>Event filter: </span><input id="filterSaltEvents"></input>
</br>
<input type="checkbox" id="stackEvents"> Do not stack events</input>
</br>
<input type="checkbox" id="clusterCheckbox"> Enable clustering</input>
</br>
<input type="checkbox" id="focus" checked> Focus on selection</input>
</br>
</div>
</p>
<div id="visualization"></div>
<script>

var groups = new vis.DataSet();

var container = document.getElementById('visualization');
var defaultOptions = {
    template: (itemData, element, data) => {
        if (data.isCluster) {
            return `<div>${data.items.length} items</div>`;
        } else {
            return `<div>${data.content}</div>`;
        }
    },
    stack: true,
    verticalScroll: true,
    orientation: {
        axis: "both",
        item: "bottom"
    },
    margin: {
        item: 10, // minimal margin between items
        axis: 5 // minimal margin between items and the axis
    },
    //zoomKey: 'ctrlKey',
    groupOrder: 'id', // groupOrder can be a property name or a sorting function
    maxHeight: "800px",
    tooltip: {
        template: function(originalItemData, parsedItemData) {
            return `<span style="color:green">${originalItemData.raw}</span>`;
        }
    }
};
var items = new vis.DataSet();

{% for group in groups %}
groups.add({
    id: {{ group["id"] }},
    content: '{{ group["name"] }}'
});
{% for ev in group["events"] %}
items.add({
    id: {{ ev["id"] }},
    group: {{ group["id"] }},
    content: '{{ ev.content }}',
    raw: '{{ ev.raw|tojson }}'.replace(/\n/g, "<br />"),
    start: '{{ ev["timestamp"] }}',
    type: 'box',
    className: '{{ ev["color"] }}'
});
{% endfor %}
{% endfor %}

var timeline = new vis.Timeline(container);
timeline.setOptions(defaultOptions);
timeline.setGroups(groups);
timeline.setItems(items);

$('#clusterCheckbox').change(function() {
    var options = {};
    if (this.checked) {
        var clusterOpts = {
            cluster: {
                titleTemplate: "{count} events.",
                showStipes: true,
            }
        };
        Object.assign(options, defaultOptions, clusterOpts);
    } else {
        Object.assign(options, defaultOptions);
    }
    timeline.setOptions(options);
});

$('#stackEvents').change(function() {
    var options = {};
    if (this.checked) {
        var stackOpts = {
            stack: false
        };
        Object.assign(options, defaultOptions, stackOpts);
    } else {
        Object.assign(options, defaultOptions);
    }
    timeline.setOptions(options);
});

$('#filterSaltEvents').change(function() {
    var filteredItems = items.get({
        filter: function(item) {
            return item.content.includes($('#filterSaltEvents').val()) || item.raw.includes($('#filterSaltEvents').val());
        }
    });
    timeline.setItems(filteredItems);
    timeline.redraw();
});

var selectedItem = 0;

timeline.on('select', function(properties) {
    selectedItem = properties.items;
});

document.onkeydown = function(event) {
    switch (event.keyCode) {
        case 37:
            if (selectedItem >= 0) {
                selectedItem--;
            }
            var focus = document.getElementById('focus');
            timeline.setSelection(selectedItem, {
                focus: focus.checked
            });
            break;
        case 39:
            selectedItem++;
            var focus = document.getElementById('focus');
            timeline.setSelection(selectedItem, {
                focus: focus.checked
            });
            break;
    }
};

</script>
</body>
</html>
